<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Confirmación de cuenta - Clarita</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
      :root {
        --clr-bg: #FFFFFF;
        --clr-surface: #FFFFFF;
        --clr-text: #000000;
        --clr-muted: #666666;
        --clr-primary: #4F378A; /* Clarita purple */
        --clr-primary-100: #E9D5FF;
      }
      body { font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 0; background: var(--clr-bg); color: var(--clr-text); }
      .container { min-height: 100vh; display: grid; place-items: center; padding: 24px; }
      .card { max-width: 560px; width: 100%; border: 1px solid #F0F0F0; border-radius: 16px; padding: 28px; box-shadow: 0 8px 24px rgba(0,0,0,0.06); background: var(--clr-surface); }
      .logo { display:flex; justify-content:center; align-items:center; margin-bottom: 12px; }
      .title { font-size: 22px; font-weight: 600; margin: 0 0 12px; color: var(--clr-text); }
      .desc { margin: 0 0 20px; color: var(--clr-muted); }
      .status { padding: 12px 14px; border-radius: 12px; font-size: 14px; border: 1px solid var(--clr-primary-100); background: #F3E8FF; color: var(--clr-primary); }
      .small { font-size: 12px; color: var(--clr-muted); margin-top: 12px; }
      .actions { margin-top: 22px; display: flex; gap: 12px; flex-wrap: wrap; }
      .btn { appearance: none; border: 1px solid transparent; padding: 12px 16px; border-radius: 12px; background: var(--clr-primary); color: #fff; text-decoration: none; font-weight: 600; font-size: 14px; box-shadow: 0 6px 14px rgba(79,55,138,0.2); }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <div class="logo"><img src="./assets/logo.svg" alt="Clarita" width="160" height="64" /></div>
        <h1 class="title">Confirmación de cuenta</h1>
        <p class="desc">Estamos validando tu correo electrónico. Este proceso puede demorar unos segundos.</p>
        <div id="status" class="status info">Procesando…</div>
        <div class="small">Podés cerrar esta ventana cuando veas el estado “Cuenta confirmada”.</div>
        <div class="actions">
          <a id="goApp" class="btn" href="#">Ir a la app</a>
        </div>
      </div>
    </div>
    <script>
      (async function() {
        const el = (id) => document.getElementById(id);
        const setStatus = (text, type) => {
          const s = el('status');
          s.textContent = text;
          s.className = 'status ' + (type || 'info');
        };

        // CONFIGURACIÓN: Reemplaza estos valores por los de tu proyecto
        // Obtén estos valores de tu panel de Supabase en Settings > API
        const SUPABASE_URL = 'TU_SUPABASE_URL_AQUI';
        const SUPABASE_ANON_KEY = 'TU_SUPABASE_ANON_KEY_AQUI';

        // Opcional: URLs de destino post-confirmación
        const DEFAULT_APP_URL = 'clarita://auth-redirect';

        // Permitir override por query string ?redirect_to=...
        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');
        const type = params.get('type'); // signup, invite, magiclink, recovery
        const tokenHash = params.get('token_hash') || params.get('token');
        const redirectTo = params.get('redirect_to') || DEFAULT_APP_URL;

        el('goApp').href = redirectTo;

        // Inicializar Supabase
        let supa;
        try {
          supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (e) {
          setStatus('Error de configuración: completa SUPABASE_URL y SUPABASE_ANON_KEY', 'error');
          return;
        }

        // Intentar confirmar según el tipo de enlace recibido
        try {
          if (code) {
            // Caso OAuth/Magic link: usar exchangeCodeForSession
            const { data, error } = await supa.auth.exchangeCodeForSession({ code });
            if (error) {
              console.warn('exchangeCodeForSession error:', error);
              setStatus('Cuenta confirmada (o ya estaba confirmada). Ya podés volver a la app.', 'success');
            } else {
              setStatus('Cuenta confirmada correctamente. Ya podés volver a la app.', 'success');
            }
          } else if (tokenHash && type) {
            // Caso email verification/reset: usar verifyOtp con token_hash
            const { data, error } = await supa.auth.verifyOtp({ type, token_hash: tokenHash });
            if (error) {
              console.warn('verifyOtp error:', error);
              setStatus('No pudimos confirmar el correo. Probá abrir el enlace de nuevo.', 'error');
            } else {
              setStatus('Cuenta confirmada correctamente. Ya podés volver a la app.', 'success');
            }
          } else {
            setStatus('Redirección recibida. Si iniciaste desde un correo de confirmación, tu cuenta ya debería estar activa.', 'success');
          }

          // Redirección automática si ?autoredirect=1
          const auto = params.get('autoredirect');
          if (auto === '1') {
            setTimeout(() => { window.location.href = redirectTo; }, 800);
          }
        } catch (e) {
          console.error(e);
          setStatus('Ocurrió un error al confirmar tu cuenta. Intenta abrir nuevamente el enlace del correo.', 'error');
        }
      })();
    </script>
  </body>
  </html>



